
<!DOCTYPE html>
<html lang="en" style="background: #213744">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Star Notary</title>
  <link rel="stylesheet" type="text/css" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.2/css/bulma.min.css">
  <script src="https://cdn.jsdelivr.net/gh/ethereum/web3.js/dist/web3.min.js"></script>

  <script src="/ABI.js"></script>

  <script defer src="https://use.fontawesome.com/releases/v5.3.1/js/all.js"></script>


  <style>

  body,
  html {
    height: 100%;
    margin: 0;
    font: 400 15px/1.8 'Lato', sans-serif;
  }

  .screenBackground {
    position: relative;
    opacity: 1;
    background-position: center;
    background-repeat: no-repeat;
    background-size: cover;
    background-image: url('images/background3.jpeg');
    height: 100%;
  }

  #screen {
    position: absolute;
    left: 0;
    top: 0;
    width: 100%;
    text-align: center;
    color: #000;
  }

  .modal-background {
    align-items: center;
    display: flex;
  }

  h1, h2 {
    color: #fff !important;
    text-shadow: 1px 1px #000;
  }

  h2 {
    margin-bottom: 15px !important;
  }

  article.media {
    background: #fff;
    border-radius: 4px;
    padding: 10px;
  }

  .image img {
    min-height: 100%;
  }

  .bigImage {
    border: 4px solid white;
    margin: 0 auto;
    display: block;
    max-width: 80%;
  }

  #star-show .content > p {
    margin-bottom: 5px;
  }
  #star-show .buttons .button,
  #star-show .content,
  #star-show .buttons:not(:last-child) {
    margin-bottom: 0;
  }

  #star-show .button {
    font-size: 10px;
  }

  </style>
</head>

<body>

  <div class="modal">




  </div>

  <div class="screenBackground"></div>
  <!-- Add a Star -->

  <section class="section" id="screen">

    <div class="container">
      <div class="column">
        <h1 class="title">Star Notary</h1>
        <h2 class="subtitle">Register your Star</h2>
      </div>
    </div>

    <div class="container">

      <div class="columns">
        <div class="column">
          <div class="field">
            <p class="control has-icons-left">
              <input class="input" type="text" placeholder="Star Name" id="star-name" />
              <span class="icon is-small is-left">
                <i class="fas fa-star"></i>
              </span>
            </p>
          </div>
        </div>
        <div class="is-divider-vertical" data-content="AND"></div>
        <div class="column">
          <div class="field">
            <p class="control has-icons-left">
              <input class="input" type="text" placeholder="Star Story" id="star-story" />
              <span class="icon is-small is-left">
                <i class="fas fa-signature"></i>
              </span>
            </p>
          </div>
        </div>
      </div>

      <div class="container">

        <div class="columns">
          <div class="column">
            <div class="field">
              <p class="control has-icons-left">
                <input class="input" type="text" placeholder="Star RA" id="star-ra" />
                <span class="icon is-small is-left">
                  <i class="fas fa-map-marked-alt"></i>
                </span>
              </p>
            </div>
          </div>
          <div class="is-divider-vertical" data-content="AND"></div>
          <div class="column">
            <div class="field">
              <p class="control has-icons-left">
                <input class="input" type="text" placeholder="Star DEC" id="star-dec" />
                <span class="icon is-small is-left">
                  <i class="fas fa-map-marked-alt"></i>
                </span>
              </p>
            </div>
          </div>
          <div class="column">
            <div class="field">
              <p class="control has-icons-left">
                <input class="input" type="text" placeholder="Star MAG" id="star-mag" />
                <span class="icon is-small is-left">
                  <i class="fas fa-map-marked-alt"></i>
                </span>
              </p>
            </div>
          </div>
        </div>


        <div id="star-answer">
        </div>

        <div class="container">
          <div class="field is-grouped is-grouped-centered">
            <p class="control" style="margin-top: 20px;">
              <a class="button is-primary" id="claim-button" onclick="claimButtonClicked()">
                Submit
              </a>
            </p>
          </div>
        </div>
      </div>



      <hr />

      <!-- Here to check for a Star -->
      <div class="container">
        <div class="column">
          <h2 class="subtitle">Retrieve Star</h2>
        </div>
      </div>

      <div class="container">
        <div class="columns">
          <div class="column is-4">
            <div class="field">
              <p class="control has-icons-left">
                <input class="input" type="text" placeholder="Place your Token" id="star-token" />
                <span class="icon is-small is-left">
                  <i class="fas fa-fingerprint"></i>
                </span>
              </p>

              <div class="field is-grouped ">
                <p class="control" style="margin-top: 30px;">
                  <a class="button is-primary" id="check-button" onclick="checkStarByTx()">
                    Retrieve Star Data
                  </a>
                </p>
              </div>
            </div>
          </div>
          <div class="is-divider-vertical" data-content="AND"></div>
          <div class="column">
          </div>
        </div>


        <div id="star-show"></div>
      </div>

    </div>







  </div>

</section>

<script>
if (typeof web3 !== 'undefined') {
  web3 = new Web3(web3.currentProvider);
} else {
  // set the provider you want from Web3.providers
  web3 = new Web3(new Web3.providers.HttpProvider('http://localhost:8545'));
}

// The default (top) wallet account from a list of test accounts
//web3.eth.defaultAccount = web3.eth.accounts[0];
web3.eth.getAccounts(function(error, accounts) {
  web3.eth.defaultAccount = web3.eth.accounts[0];
});

const modalWindow = document.querySelector('body > .modal');

// Modal template 1: no MetaMask
const noMetamaskAcCtemplate =
  '<div class="modal-background"></div><div class="modal-card"> <header class="modal-card-head"> <p class="modal-card-title">Warning!</p> <button class="delete close" aria-label="close"></button> </header> <section class="modal-card-body"> Please, login into your MetaMask account. </section> <footer class="modal-card-foot"> <button class="button close">OK</button> </footer> </div>';

// Modal template 2: zoom image
let showFullImage = function(imagePath) {
  return (
    '<div class="modal-background"><img src="' +
    imagePath +
    '" class="bigImage"></div><button class="modal-close is-large close" aria-label="close"></button>'
  );
};

//console.log(showFullImage());

if (!web3.eth.defaultAccount) {
  // We dont care about IE9
  modalWindow.classList.add('is-active');
  modalContent(noMetamaskAcCtemplate);
  eventsForClosing();
}

function eventsForClosing() {
  document.querySelectorAll('.close').forEach(function(elem) {
    elem.addEventListener('click', closeModal);
  });
}

function closeModal() {
  modalWindow.classList.remove('is-active');
}

function modalContent(type, imagePath) {
  if (imagePath) {
    document.querySelector('.modal').innerHTML = type(imagePath);
    return;
  }
  document.querySelector('.modal').innerHTML = type;
}

// The interface definition for your smart contract (the ABI) >> build/contracts/StarNotary.json > abi property
var StarNotary = web3.eth.contract(ABI);
// Grab the contract at specified deployed address with the >> interface defined by the ABI
var starNotary = StarNotary.at('0xF7c71e77b4E0670019D4e4C89Be877428A25489d');

const starImage = 'images/starIcon.png';
const radar = 'images/radar.gif'; // For loading

let name, particularSection;

let basicTemplateCard = (starImageClass, starImage, name, particularSection) =>
  '<article class="media"><figure class="media-left"><p class="image is-64x64"><img src="' +
  starImage +
  '" class="' +
  starImageClass +
  '" ></p></figure><div class="media-content"><div class="content"><p><strong>' +
  name +
  '</strong>' +
  particularSection +
  '</p></div><div></article>';

function claimButtonClicked() {
  web3.eth.getAccounts(function(error, accounts) {
    if (error) {
      console.log(error);
      return;
    }

    var account = accounts[0];
    name = document.querySelector('#star-name').value;
    const story = document.querySelector('#star-story').value;
    const ra = document.querySelector('#star-ra').value;
    const dec = document.querySelector('#star-dec').value;
    const mag = document.querySelector('#star-mag').value;

    starNotary.createStar.sendTransaction(name, story, ra, dec, mag, function(
      error,
      result
    ) {
      document.querySelector('#star-answer').innerHTML =
        '<b>Loading...</b> Please wait...!';

      shortTx = result.substring(0, 4);

      if (!error) {
        particularSection =
          '<br>Great! </b>Check your transaction here <a href="https://rinkeby.etherscan.io/tx/' +
          result +
          '">' +
          shortTx +
          '...</a>';
        document.querySelector('#star-answer').innerHTML = basicTemplateCard(
          'register',
          starImage,
          name,
          particularSection
        );

        var starClaimedEvent = starNotary.Transfer({ from: account });
        starClaimedEvent.watch(function(error, result) {
          console.log(result);
          if (!error) {
            console.log('If I see this Tx should be done!');
            //location.reload();
          } else {
            console.log('watching for star claimed event is failing');
          }
        });
      } else {
        console.log(error);
      }
    });
  });
}

function checkStarByTx() {
  web3.eth.getAccounts(function(error, accounts) {
    if (error) {
      console.log(error);
      return;
    }
    var account = accounts[0];
    const tokenId = document.querySelector('#star-token').value;
    if (tokenId == '' || tokenId == ' ') {
      alert('Token should be something...!');
      return;
    }
    if (!tokenId.match(/^[0-9]*$/gm)) {
      alert('Token should be a number...!');
      return;
    }

    // We pass the image

    var url = '/star';
    var data = { tokenId };

    fetch(url, {
      method: 'POST', // or 'PUT'
      body: JSON.stringify(data), // data can be `string` or {object}!
      headers: {
        'Content-Type': 'application/json'
      }
    })
      .then(res => res.json())
      .then(response => {
        // It should retrieve something like: {"imagePath":"public/images/2.png"}
        //alert(JSON.stringify(response));
        document.querySelector('.retrieve').src = response.imagePath;
        document.querySelector('.retrieve').onclick = function() {
          modalWindow.classList.add('is-active');
          modalContent(showFullImage, response.imagePath);
          eventsForClosing();
        };
      })
      //.then(response => console.log('Success:', JSON.stringify(response)))
      .catch(error => console.error('Error:', error));

    document.querySelector('#star-show').innerHTML =
      '<b>Loading...</b> Please wait...!';

    starNotary.tokenIdToStarInfo.call(tokenId, function(error, result) {
      if (!error) {
        if (!result[0]) {
          document.querySelector('#star-show').innerHTML =
            '<b>Please, provide a valid token</b>';
          return;
        }

        console.log(result);

        const secStarStory =
          '<span style="display: block;"><span class="icon"><i class="fas fa-signature"></i></span>' +
          result[1] +
          '</span>';

        const secStarInfo =
          '<div class="buttons has-addons"> <span class="button">RA: ' +
          result[2] +
          '</span> <span class="button">DEC: ' +
          result[3] +
          '</span> <span class="button">RA: ' +
          result[4] +
          '</span> </div>';

        particularSection = secStarStory;
        particularSection += secStarInfo;

        const yourStarImage = 'images/' + tokenId + '.png';

        let starResponse = basicTemplateCard(
          'retrieve',
          radar,
          result[0],
          particularSection
        );

        //console.log(starResponse);
        document.querySelector('#star-show').innerHTML = starResponse;
      } else {
        console.log(error);
      }
    });
  });
}
</script>

</body>
</html>
